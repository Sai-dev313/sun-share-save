

# Lifetime Impact Narrator + SolarGPT Insight Cards

## Overview

Two new AI-powered features for the dashboards:

1. **Lifetime Impact Pill** -- A single-sentence banner on each dashboard showing the user's personal lifetime contribution to clean energy, generated by AI based on their actual data.

2. **SolarGPT Insight Cards** -- A card-based Q&A panel (not a chatbot) where users select from 5 predefined questions and get grounded, data-driven explanations about their SolarCredit activity.

Both features need to use OpenAI (i will provide my API key ask me) via new backend functions.

---

## Feature 1: Lifetime Impact Pill

A small banner displayed on both Producer and Consumer dashboards, showing a single AI-generated sentence like:

- Producer: *"Your solar system has sent 214 clean units to the grid -- replacing coal power with sunshine."*
- Consumer: *"You helped enable 87 solar units to enter the grid by purchasing clean credits."*

### How it works

- On dashboard load, fetch the user's lifetime stats from the database
- Send those stats to a backend function that calls Lovable AI with the Lifetime Impact Narrator prompt
- Display the resulting sentence in a styled pill/banner
- If lifetime contribution is 0, show a neutral encouraging message

### Data source

- **Producers**: `SUM(sent_to_grid)` from `energy_logs` for that user
- **Consumers**: `SUM(credits)` purchased (tracked via `transactions` table)
- CO2 avoided: computed as `units * 0.82` kg (deterministic, not AI-generated)

---

## Feature 2: SolarGPT Insight Cards

A new action icon "SolarGPT" in the dashboard action grid. When tapped, it shows 5 clickable question cards. Tapping a card fetches an AI-generated explanation based on the user's real data.

### The 5 Cards

1. "How did I earn these credits?"
2. "What's my lifetime impact?"
3. "What happens if I sell vs use credits?"
4. "How can I increase my contribution?"
5. "Where did my solar energy go?"

Each answer is 4-6 sentences, role-aware (producer vs consumer), and grounded in real data.

### How it works

- User taps SolarGPT icon in the action grid
- Sees 5 question cards
- Taps one card
- Loading state while the backend function fetches the answer
- Answer displayed below the card
- User can tap another card to switch

---

## Technical Details

### Database Migration

Add a view or query capability for lifetime stats. No new tables needed -- we aggregate from existing data:

```sql
-- For producers: lifetime units sent to grid
SELECT COALESCE(SUM(sent_to_grid), 0) as lifetime_units
FROM energy_logs WHERE user_id = $1;

-- For consumers: lifetime credits purchased (from transactions)
SELECT COALESCE(SUM(amount), 0) as lifetime_units
FROM transactions WHERE user_id = $1 AND type = 'purchase';
```

### New Backend Functions

**1. `supabase/functions/generate-lifetime-impact/index.ts`**

- Receives: `user_id` (from auth token)
- Queries the user's role and lifetime stats from the database
- Sends data + the Lifetime Impact Narrator prompt to Lovable AI gateway
- Returns a single sentence

**2. `supabase/functions/solargpt/index.ts`**

- Receives: `question_id` (1-5) from the request body
- Queries the user's role, credit balance, lifetime stats from the database
- Sends data + the SolarGPT prompt (with the specific card instructions) to Lovable AI gateway
- Returns 4-6 sentence explanation

Both functions use `LOVABLE_API_KEY` (already available) and the Lovable AI gateway at `https://ai.gateway.lovable.dev/v1/chat/completions`.

### New Frontend Components

**1. `src/components/dashboard/LifetimeImpactPill.tsx`**

- Fetches from the `generate-lifetime-impact` edge function on mount
- Displays a styled pill with a leaf icon and the AI sentence
- Shows skeleton while loading, hides on error
- Props: none (reads auth context internally)

**2. `src/components/dashboard/panels/SolarGPTPanel.tsx`**

- Shows 5 question cards as clickable buttons
- On click, calls the `solargpt` edge function with the question ID
- Displays the answer below in a styled card
- Loading state per question

### Modified Files

| File | Change |
|------|--------|
| `src/components/dashboard/ActionIconGrid.tsx` | Add "SolarGPT" action icon for both roles |
| `src/pages/ProducerDashboard.tsx` | Add LifetimeImpactPill, add SolarGPT panel case |
| `src/pages/ConsumerDashboard.tsx` | Add LifetimeImpactPill, add SolarGPT panel case |
| `supabase/config.toml` | Register new edge functions (auto-handled) |

### New Files

| File | Purpose |
|------|---------|
| `supabase/functions/generate-lifetime-impact/index.ts` | Lifetime impact narrator edge function |
| `supabase/functions/solargpt/index.ts` | SolarGPT card answers edge function |
| `src/components/dashboard/LifetimeImpactPill.tsx` | Dashboard impact pill component |
| `src/components/dashboard/panels/SolarGPTPanel.tsx` | SolarGPT question cards panel |

### AI Model

Both functions will use `google/gemini-3-flash-preview` (default Lovable AI model) -- fast, efficient, and suitable for short factual narration.

### Prompt Integration

- The Lifetime Impact Narrator prompt you provided will be embedded as the system prompt in the `generate-lifetime-impact` function
- The SolarGPT prompt will be embedded as the system prompt in the `solargpt` function, with the specific card instructions selected based on `question_id`

### Error Handling

- 429 (rate limit) and 402 (payment required) errors are caught and surfaced to the user via toast
- If AI fails, the lifetime pill hides gracefully; SolarGPT shows a friendly error message
- Zero-state handling is built into both prompts

